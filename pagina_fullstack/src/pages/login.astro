---
import bcrypt from "bcryptjs";
import { supabase } from "../lib/supabase";
import "../styles/login.css";

let message = "";
let errorMsg = "";

// Si ya hay sesión, redirige
const existing = Astro.cookies.get("uid")?.value;
if (existing) {
  return Astro.redirect("/gestor");
}

if (Astro.request.method === "POST") {
  try {
    const form = await Astro.request.formData();
    const correo = String(form.get("correo") ?? "").trim().toLowerCase();
    const password = String(form.get("password") ?? "");

    if (!correo || !password) {
      errorMsg = "Completa correo y contraseña";
    } else {
      const { data: user, error } = await supabase
        .from("users")
        .select("*")
        .eq("correo", correo)
        .maybeSingle();

      if (error) {
        errorMsg = error.message;
      } else if (!user) {
        errorMsg = "Usuario no encontrado";
      } else {
        const hash = String((user as any)?.["contraseña"] ?? "");
        const ok = hash && bcrypt.compareSync(password, hash);

        if (!ok) {
          errorMsg = "Credenciales inválidas";
        } else {
          const uid = Number((user as any)?.id ?? 0);
          if (!uid) throw new Error("Usuario sin identificador válido.");

          Astro.cookies.set("uid", String(uid), {
            path: "/",
            httpOnly: true,
            sameSite: "lax",
            secure: true,
            maxAge: 60 * 60 * 24 * 7, // 7 días
          });

          Astro.cookies.set("ucorreo", String(user.correo ?? ""), {
            path: "/",
            httpOnly: true,
            sameSite: "lax",
            secure: true,
            maxAge: 60 * 60 * 24 * 7,
          });

          return Astro.redirect("/gestor");
        }
      }
    }
  } catch (e) {
    console.error("[login] error:", e);
    errorMsg = "Error de login";
  }
}

const title = "Iniciar sesión";
---

<html lang="es">
  <head>
    <meta charset="utf-8" />
    <title>{title}</title>
    <link rel="icon" type="image/svg+xml" href="public/favicon.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="/src/scripts/login.js" defer></script>
  </head>
  <body>
    <div class="login-container">
      <h1>{title}</h1>

      {errorMsg && <p class="mensaje error">⚠ {errorMsg}</p>}
      {message && <p class="mensaje ok">{message}</p>}

      <form method="POST" class="login-form" novalidate>
        <label for="correo">Correo</label>
        <input id="correo" name="correo" type="email" required autocomplete="email" />

        <label for="password">Contraseña</label>
        <input id="password" name="password" type="password" required autocomplete="current-password" />

        <button type="submit" class="btn-neon">Entrar</button>
      </form>

      <a href="/registro" class="volver">¿No tienes cuenta? Regístrate</a> <br>
      <a href="/" class="volver">⬅ Volver al inicio</a>
    </div>
  </body>
</html>