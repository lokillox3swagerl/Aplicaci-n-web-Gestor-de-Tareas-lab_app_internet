---
import { addUser } from "../lib/api";
import bcrypt from "bcryptjs";

let message = "";

if (Astro.request.method === "POST") {
  try {
    const formData = await Astro.request.formData();
    const nombre = formData.get("nombre") as string;
    const apellido = formData.get("apellido") as string;
    const correo = formData.get("correo") as string;
    const password = formData.get("password") as string;

    const hashedPassword = bcrypt.hashSync(password, 10);

    await addUser({
      nombre,
      apellido,
      correo,
      contraseña: hashedPassword,
    });

    message = "Usuario registrado con éxito";
  } catch (err) {
    console.error("Error en registro:", err);
    message = "No se pudo registrar el usuario";
  }
}
---

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Registro</title>
    <link rel="stylesheet" href="/src/styles/registro.css" />
    <script src="/src/scripts/registro.js" defer></script>
  </head>
  <body>
    <div class="registro-container">
      <h1>Registro de Usuario</h1>

      {message && <p class="mensaje">{message}</p>}

      <form method="POST" class="registro-form">
        <label>Nombre:</label>
        <input type="text" name="nombre" required />

        <label>Apellido:</label>
        <input type="text" name="apellido" required />

        <label>Correo:</label>
        <input type="email" name="correo" required />

        <label>Contraseña:</label>
        <input type="password" name="password" required />

        <button type="submit" class="btn-neon">Registrar</button>
      </form>

      <a href="/" class="volver">⬅ Volver al inicio</a>
    </div>
  </body>
</html>